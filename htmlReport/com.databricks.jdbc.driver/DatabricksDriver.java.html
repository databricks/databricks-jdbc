<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksDriver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.driver</a> &gt; <span class="el_source">DatabricksDriver.java</span></div><h1>DatabricksDriver.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.driver;

import static com.databricks.jdbc.driver.DatabricksJdbcConstants.*;

import com.databricks.jdbc.commons.util.AppenderUtil;
import com.databricks.jdbc.core.DatabricksConnection;
import com.databricks.jdbc.core.DatabricksSQLException;
import com.databricks.jdbc.telemetry.DatabricksMetrics;
import com.databricks.sdk.core.UserAgent;
import java.sql.*;
import java.util.Properties;
import org.apache.logging.log4j.Level;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.logging.log4j.core.Appender;
import org.apache.logging.log4j.core.LoggerContext;
import org.apache.logging.log4j.core.config.Configuration;
import org.apache.logging.log4j.core.config.LoggerConfig;
import org.apache.logging.log4j.core.layout.PatternLayout;

/**
 * Databricks JDBC driver. TODO: Add implementation to accept Urls in format:
 * jdbc:databricks://host:port.
 */
<span class="fc" id="L25">public class DatabricksDriver implements Driver {</span>

<span class="fc" id="L27">  private static final Logger LOGGER = LogManager.getLogger(DatabricksDriver.class);</span>
  private static final DatabricksDriver INSTANCE;

  private static final int majorVersion = 0;
  private static final int minorVersion = 0;
  private static final int buildVersion = 1;

  static {
    try {
<span class="fc" id="L36">      DriverManager.registerDriver(INSTANCE = new DatabricksDriver());</span>
<span class="fc" id="L37">      System.out.printf(&quot;Driver has been registered. instance = %s\n&quot;, INSTANCE);</span>
<span class="nc" id="L38">    } catch (SQLException e) {</span>
<span class="nc" id="L39">      throw new IllegalStateException(&quot;Unable to register &quot; + DatabricksDriver.class, e);</span>
<span class="fc" id="L40">    }</span>
<span class="fc" id="L41">  }</span>

  @Override
  public boolean acceptsURL(String url) {
<span class="nc" id="L45">    return DatabricksConnectionContext.isValid(url);</span>
  }

  @Override
  public Connection connect(String url, Properties info) throws DatabricksSQLException {
<span class="nc" id="L50">    LOGGER.debug(&quot;public Connection connect(String url = {}, Properties info)&quot;, url);</span>
<span class="nc" id="L51">    IDatabricksConnectionContext connectionContext = DatabricksConnectionContext.parse(url, info);</span>
<span class="nc" id="L52">    configureLogging(</span>
<span class="nc" id="L53">        connectionContext.getLogPathString(),</span>
<span class="nc" id="L54">        connectionContext.getLogLevel(),</span>
<span class="nc" id="L55">        connectionContext.getLogFileCount(),</span>
<span class="nc" id="L56">        connectionContext.getLogFileSize());</span>
<span class="nc" id="L57">    setUserAgent(connectionContext);</span>
<span class="nc" id="L58">    DatabricksMetrics.instantiateTelemetryClient(connectionContext);</span>
    try {
<span class="nc" id="L60">      return new DatabricksConnection(connectionContext);</span>
<span class="nc" id="L61">    } catch (Exception e) {</span>
<span class="nc" id="L62">      throw new DatabricksSQLException(</span>
<span class="nc" id="L63">          &quot;Invalid or unknown token or hostname provided :&quot; + connectionContext.getHostUrl(), e);</span>
    }
  }

  @Override
  public int getMajorVersion() {
<span class="nc" id="L69">    return majorVersion;</span>
  }

  @Override
  public int getMinorVersion() {
<span class="nc" id="L74">    return minorVersion;</span>
  }

  @Override
  public DriverPropertyInfo[] getPropertyInfo(String url, Properties info) {
<span class="nc" id="L79">    throw new UnsupportedOperationException(&quot;Not implemented&quot;);</span>
  }

  @Override
  public boolean jdbcCompliant() {
<span class="nc" id="L84">    return false;</span>
  }

  @Override
  public java.util.logging.Logger getParentLogger() {
<span class="nc" id="L89">    return null;</span>
  }

  public static DatabricksDriver getInstance() {
<span class="fc" id="L93">    return INSTANCE;</span>
  }

  public static void main(String[] args) {
<span class="nc" id="L97">    LOGGER.info(&quot;The driver {} has been initialized.&quot;, DatabricksDriver.class);</span>
<span class="nc" id="L98">  }</span>

  private static String getVersion() {
<span class="fc" id="L101">    return String.format(&quot;%d.%d.%d&quot;, majorVersion, minorVersion, buildVersion);</span>
  }

  public static void setUserAgent(IDatabricksConnectionContext connectionContext) {
<span class="fc" id="L105">    UserAgent.withProduct(DatabricksJdbcConstants.DEFAULT_USER_AGENT, getVersion());</span>
<span class="fc" id="L106">    UserAgent.withOtherInfo(CLIENT_USER_AGENT_PREFIX, connectionContext.getClientUserAgent());</span>
<span class="fc" id="L107">  }</span>

  private static void configureLogger(Appender appender, Level logLevel) {
<span class="nc" id="L110">    LoggerContext context = (LoggerContext) LogManager.getContext(false);</span>
<span class="nc" id="L111">    Configuration config = context.getConfiguration();</span>
<span class="nc" id="L112">    LoggerConfig loggerConfig = config.getLoggerConfig(LogManager.ROOT_LOGGER_NAME);</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">    if (appender != null) {</span>
<span class="nc" id="L115">      appender.start();</span>
<span class="nc" id="L116">      config.addAppender(appender);</span>
<span class="nc" id="L117">      loggerConfig.addAppender(appender, logLevel, null);</span>
    }

<span class="nc" id="L120">    loggerConfig.setLevel(logLevel);</span>
<span class="nc" id="L121">    context.updateLoggers();</span>
<span class="nc" id="L122">  }</span>

  public static void configureLogging(
      String logDirectory, Level logLevel, int logFileCount, int logFileSize) {
<span class="nc" id="L126">    LoggerContext context = (LoggerContext) LogManager.getContext(false);</span>
<span class="nc" id="L127">    Configuration config = context.getConfiguration();</span>
<span class="nc" id="L128">    PatternLayout layout = AppenderUtil.getPatternLayout(config, DEFAULT_LOG_PATTERN);</span>
<span class="nc" id="L129">    boolean isFilePath = logDirectory.matches(&quot;.*\\.(log|txt|json|csv|xml|out)$&quot;);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">    if (isFilePath) {</span>
<span class="nc" id="L131">      configureLogger(AppenderUtil.getFileAppender(config, layout, logDirectory), logLevel);</span>
    } else {
<span class="nc" id="L133">      configureLogger(</span>
<span class="nc" id="L134">          AppenderUtil.getRollingFileAppender(</span>
              config, layout, logDirectory, logFileSize, logFileCount - 1),
          logLevel);
    }
<span class="nc" id="L138">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>