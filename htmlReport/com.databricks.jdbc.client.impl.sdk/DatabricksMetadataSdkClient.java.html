<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksMetadataSdkClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.client.impl.sdk</a> &gt; <span class="el_source">DatabricksMetadataSdkClient.java</span></div><h1>DatabricksMetadataSdkClient.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.client.impl.sdk;

import static com.databricks.jdbc.client.impl.sdk.ResultConstants.TYPE_INFO_RESULT;

import com.databricks.jdbc.client.DatabricksMetadataClient;
import com.databricks.jdbc.client.StatementType;
import com.databricks.jdbc.commons.util.WildcardUtil;
import com.databricks.jdbc.core.DatabricksResultSet;
import com.databricks.jdbc.core.IDatabricksSession;
import com.databricks.jdbc.core.ImmutableSqlParameter;
import com.databricks.sdk.service.sql.StatementState;
import com.databricks.sdk.service.sql.StatementStatus;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.util.*;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.CopyOnWriteArrayList;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

/** Implementation for DatabricksMetadataClient using SDK client */
public class DatabricksMetadataSdkClient implements DatabricksMetadataClient {

<span class="nc" id="L27">  private static final Logger LOGGER = LogManager.getLogger(DatabricksSdkClient.class);</span>

  private final DatabricksSdkClient sdkClient;

<span class="nc" id="L31">  public DatabricksMetadataSdkClient(DatabricksSdkClient sdkClient) {</span>
<span class="nc" id="L32">    this.sdkClient = sdkClient;</span>
<span class="nc" id="L33">  }</span>

  @Override
  public DatabricksResultSet listTypeInfo(IDatabricksSession session) {
<span class="nc" id="L37">    return TYPE_INFO_RESULT;</span>
  }

  @Override
  public DatabricksResultSet listCatalogs(IDatabricksSession session) throws SQLException {
<span class="nc" id="L42">    String showCatalogsSQL = &quot;show catalogs&quot;;</span>
<span class="nc" id="L43">    LOGGER.debug(&quot;SQL command to fetch catalogs: {}&quot;, showCatalogsSQL);</span>

<span class="nc" id="L45">    ResultSet rs =</span>
<span class="nc" id="L46">        sdkClient.executeStatement(</span>
            showCatalogsSQL,
<span class="nc" id="L48">            session.getComputeResource(),</span>
            new HashMap&lt;Integer, ImmutableSqlParameter&gt;(),
            StatementType.METADATA,
            session,
            null /* parentStatement */);
<span class="nc" id="L53">    List&lt;List&lt;Object&gt;&gt; rows = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L54" title="All 2 branches missed.">    while (rs.next()) {</span>
<span class="nc" id="L55">      rows.add(Collections.singletonList(rs.getString(1)));</span>
    }
<span class="nc" id="L57">    return new DatabricksResultSet(</span>
<span class="nc" id="L58">        new StatementStatus().setState(StatementState.SUCCEEDED),</span>
        &quot;getcatalogs-metadata&quot;,
<span class="nc" id="L60">        Collections.singletonList(&quot;TABLE_CAT&quot;),</span>
<span class="nc" id="L61">        Collections.singletonList(&quot;VARCHAR&quot;),</span>
<span class="nc" id="L62">        Collections.singletonList(Types.VARCHAR),</span>
<span class="nc" id="L63">        Collections.singletonList(128),</span>
        rows,
        StatementType.METADATA);
  }

  @Override
  public DatabricksResultSet listSchemas(
      IDatabricksSession session, String catalog, String schemaNamePattern) throws SQLException {
    // Since catalog must be an identifier or all catalogs (null), we need not care about catalog
    // regex
<span class="nc" id="L73">    Queue&lt;String&gt; catalogs = new ConcurrentLinkedQueue&lt;&gt;();</span>
<span class="nc bnc" id="L74" title="All 2 branches missed.">    if (WildcardUtil.isMatchAnything(catalog)) {</span>
<span class="nc" id="L75">      ResultSet rs = listCatalogs(session);</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">      while (rs.next()) {</span>
<span class="nc" id="L77">        catalogs.add(rs.getString(1));</span>
      }
<span class="nc" id="L79">    } else {</span>
<span class="nc" id="L80">      catalogs.add(catalog);</span>
    }
    // TODO: Remove post demo
<span class="nc bnc" id="L83" title="All 2 branches missed.">    while (catalogs.size() &gt; 5) catalogs.poll();</span>

<span class="nc" id="L85">    List&lt;List&lt;Object&gt;&gt; rows = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="nc" id="L86">    ExecutorService executorService = Executors.newFixedThreadPool(150);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">    for (int i = 0; i &lt; 150; i++) {</span>
<span class="nc" id="L88">      executorService.submit(</span>
          () -&gt; {
<span class="nc bnc" id="L90" title="All 2 branches missed.">            while (!catalogs.isEmpty()) {</span>
<span class="nc" id="L91">              String currentCatalog = catalogs.poll();</span>
              // TODO: Emoji characters are not being handled correctly by SDK/SEA, hence, skipping
              // for now
              //          if (WildcardUtil.containsEmoji(currentCatalog))
              //            return;
<span class="nc" id="L96">              String showSchemaSQL = &quot;show schemas in `&quot; + currentCatalog + &quot;`&quot;;</span>
<span class="nc" id="L97">              String schemaWithContext = WildcardUtil.jdbcPatternToHive(schemaNamePattern);</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">              if (!WildcardUtil.isMatchAnything(schemaWithContext)) {</span>
<span class="nc" id="L99">                showSchemaSQL += &quot; like '&quot; + schemaNamePattern + &quot;'&quot;;</span>
              }
<span class="nc" id="L101">              LOGGER.debug(&quot;SQL command to fetch schemas: {}&quot;, showSchemaSQL);</span>
              try {
<span class="nc" id="L103">                ResultSet rs =</span>
<span class="nc" id="L104">                    sdkClient.executeStatement(</span>
                        showSchemaSQL,
<span class="nc" id="L106">                        session.getComputeResource(),</span>
                        new HashMap&lt;Integer, ImmutableSqlParameter&gt;(),
                        StatementType.METADATA,
                        session,
                        null /* parentStatement */);
<span class="nc bnc" id="L111" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L112">                  rows.add(Arrays.asList(rs.getString(1), currentCatalog));</span>
                }
<span class="nc" id="L114">              } catch (SQLException e) {</span>
<span class="nc" id="L115">                throw new RuntimeException(e);</span>
<span class="nc" id="L116">              }</span>
<span class="nc" id="L117">            }</span>
<span class="nc" id="L118">          });</span>
    }
<span class="nc" id="L120">    executorService.shutdown();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">    while (!executorService.isTerminated()) {</span>
      // wait
    }
<span class="nc" id="L124">    rows.sort(</span>
<span class="nc" id="L125">        Comparator.comparing((List&lt;Object&gt; i) -&gt; i.get(1).toString())</span>
<span class="nc" id="L126">            .thenComparing(i -&gt; i.get(0).toString()));</span>
<span class="nc" id="L127">    return new DatabricksResultSet(</span>
<span class="nc" id="L128">        new StatementStatus().setState(StatementState.SUCCEEDED),</span>
        &quot;metadata-statement&quot;,
<span class="nc" id="L130">        Arrays.asList(&quot;TABLE_SCHEM&quot;, &quot;TABLE_CATALOG&quot;),</span>
<span class="nc" id="L131">        Arrays.asList(&quot;VARCHAR&quot;, &quot;VARCHAR&quot;),</span>
<span class="nc" id="L132">        Arrays.asList(Types.VARCHAR, Types.VARCHAR),</span>
<span class="nc" id="L133">        Arrays.asList(128, 128),</span>
        rows,
        StatementType.METADATA);
  }

  @Override
  public DatabricksResultSet listTables(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String tableNamePattern,
      String[] tableTypes)
      throws SQLException {

<span class="nc" id="L147">    Queue&lt;Map.Entry&lt;String, String&gt;&gt; catalogSchemaPairs = new ConcurrentLinkedQueue&lt;&gt;();</span>
<span class="nc bnc" id="L148" title="All 4 branches missed.">    if (WildcardUtil.isWildcard(schemaNamePattern) || WildcardUtil.isMatchAnything(catalog)) {</span>
<span class="nc" id="L149">      ResultSet resultSet = listSchemas(session, catalog, schemaNamePattern);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">      while (resultSet.next()) {</span>
<span class="nc" id="L151">        catalogSchemaPairs.add(Map.entry(resultSet.getString(2), resultSet.getString(1)));</span>
      }
<span class="nc" id="L153">    } else {</span>
<span class="nc" id="L154">      catalogSchemaPairs.add(Map.entry(catalog, schemaNamePattern));</span>
    }
    // TODO: Limit to 15 pairs to run quickly, remove after demo/find workaround
<span class="nc bnc" id="L157" title="All 2 branches missed.">    while (catalogSchemaPairs.size() &gt; 15) catalogSchemaPairs.poll();</span>
<span class="nc" id="L158">    String tableWithContext = WildcardUtil.jdbcPatternToHive(tableNamePattern);</span>
<span class="nc" id="L159">    List&lt;List&lt;Object&gt;&gt; rows = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="nc" id="L160">    ExecutorService executorService = Executors.newFixedThreadPool(150);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">    for (int i = 0; i &lt; 150; i++) {</span>
<span class="nc" id="L162">      executorService.submit(</span>
          () -&gt; {
<span class="nc bnc" id="L164" title="All 2 branches missed.">            while (!catalogSchemaPairs.isEmpty()) {</span>
<span class="nc" id="L165">              Map.Entry&lt;String, String&gt; currentPair = catalogSchemaPairs.poll();</span>
<span class="nc" id="L166">              String currentCatalog = currentPair.getKey();</span>
<span class="nc" id="L167">              String currentSchema = currentPair.getValue();</span>
<span class="nc" id="L168">              String showTablesSQL = &quot;show tables from &quot; + currentCatalog + &quot;.&quot; + currentSchema;</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">              if (!WildcardUtil.isMatchAnything(tableWithContext)) {</span>
<span class="nc" id="L170">                showTablesSQL += &quot; like '&quot; + tableWithContext + &quot;'&quot;;</span>
              }
<span class="nc" id="L172">              LOGGER.debug(&quot;SQL command to fetch tables: {}&quot;, showTablesSQL);</span>
              try {
<span class="nc" id="L174">                ResultSet rs =</span>
<span class="nc" id="L175">                    sdkClient.executeStatement(</span>
                        showTablesSQL,
<span class="nc" id="L177">                        session.getComputeResource(),</span>
                        new HashMap&lt;Integer, ImmutableSqlParameter&gt;(),
                        StatementType.METADATA,
                        session,
                        null /* parentStatement */);
<span class="nc bnc" id="L182" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc" id="L183">                  rows.add(</span>
<span class="nc" id="L184">                      Arrays.asList(</span>
                          currentCatalog,
                          currentSchema,
<span class="nc" id="L187">                          rs.getString(2),</span>
                          &quot;TABLE&quot;,
                          null,
                          null,
                          null,
                          null,
                          null,
                          null));
                }
<span class="nc" id="L196">              } catch (SQLException e) {</span>
<span class="nc" id="L197">                throw new RuntimeException(e);</span>
<span class="nc" id="L198">              }</span>
<span class="nc" id="L199">            }</span>
<span class="nc" id="L200">          });</span>
    }
<span class="nc" id="L202">    executorService.shutdown();</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">    while (!executorService.isTerminated()) {</span>
      // wait
    }
    // They are ordered by TABLE_TYPE, TABLE_CAT, TABLE_SCHEM and TABLE_NAME.
<span class="nc" id="L207">    rows.sort(</span>
<span class="nc" id="L208">        Comparator.comparing((List&lt;Object&gt; i) -&gt; i.get(3).toString())</span>
<span class="nc" id="L209">            .thenComparing(i -&gt; i.get(0).toString())</span>
<span class="nc" id="L210">            .thenComparing(i -&gt; i.get(1).toString())</span>
<span class="nc" id="L211">            .thenComparing(i -&gt; i.get(2).toString()));</span>
<span class="nc" id="L212">    return new DatabricksResultSet(</span>
<span class="nc" id="L213">        new StatementStatus().setState(StatementState.SUCCEEDED),</span>
        &quot;gettables-metadata&quot;,
<span class="nc" id="L215">        Arrays.asList(</span>
            &quot;TABLE_CAT&quot;,
            &quot;TABLE_SCHEM&quot;,
            &quot;TABLE_NAME&quot;,
            &quot;TABLE_TYPE&quot;,
            &quot;REMARKS&quot;,
            &quot;TYPE_CAT&quot;,
            &quot;TYPE_SCHEM&quot;,
            &quot;TYPE_NAME&quot;,
            &quot;SELF_REFERENCING_COL_NAME&quot;,
            &quot;REF_GENERATION&quot;),
<span class="nc" id="L226">        Arrays.asList(</span>
            &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;,
            &quot;VARCHAR&quot;, &quot;VARCHAR&quot;),
<span class="nc" id="L229">        Arrays.asList(</span>
<span class="nc" id="L230">            Types.VARCHAR,</span>
<span class="nc" id="L231">            Types.VARCHAR,</span>
<span class="nc" id="L232">            Types.VARCHAR,</span>
<span class="nc" id="L233">            Types.VARCHAR,</span>
<span class="nc" id="L234">            Types.VARCHAR,</span>
<span class="nc" id="L235">            Types.VARCHAR,</span>
<span class="nc" id="L236">            Types.VARCHAR,</span>
<span class="nc" id="L237">            Types.VARCHAR,</span>
<span class="nc" id="L238">            Types.VARCHAR,</span>
<span class="nc" id="L239">            Types.VARCHAR),</span>
<span class="nc" id="L240">        Arrays.asList(128, 128, 128, 128, 128, 128, 128, 128, 128, 128),</span>
        rows,
        StatementType.METADATA);
  }

  @Override
  public DatabricksResultSet listTableTypes(IDatabricksSession session) {
<span class="nc" id="L247">    return null;</span>
  }

  @Override
  public DatabricksResultSet listColumns(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String tableNamePattern,
      String columnNamePattern)
      throws SQLException {
<span class="nc" id="L258">    ResultSet resultSet = listTables(session, catalog, schemaNamePattern, tableNamePattern, null);</span>
<span class="nc" id="L259">    Queue&lt;String[]&gt; catalogSchemaTableCombinations = new ConcurrentLinkedQueue&lt;&gt;();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">    while (resultSet.next()) {</span>
<span class="nc" id="L261">      catalogSchemaTableCombinations.add(</span>
<span class="nc" id="L262">          new String[] {resultSet.getString(1), resultSet.getString(2), resultSet.getString(3)});</span>
    }

<span class="nc" id="L265">    List&lt;List&lt;Object&gt;&gt; rows = new CopyOnWriteArrayList&lt;&gt;();</span>
<span class="nc" id="L266">    ExecutorService executorService = Executors.newFixedThreadPool(150);</span>
<span class="nc bnc" id="L267" title="All 2 branches missed.">    for (int i = 0; i &lt; 150; i++) {</span>
<span class="nc" id="L268">      executorService.submit(</span>
          () -&gt; {
<span class="nc bnc" id="L270" title="All 2 branches missed.">            while (!catalogSchemaTableCombinations.isEmpty()) {</span>
<span class="nc" id="L271">              String[] combination = catalogSchemaTableCombinations.poll();</span>
<span class="nc" id="L272">              String showColumnsSQL =</span>
                  &quot;show columns in &quot; + combination[0] + &quot;.&quot; + combination[1] + &quot;.&quot; + combination[2];
<span class="nc" id="L274">              LOGGER.debug(&quot;SQL command to fetch columns: {}&quot;, showColumnsSQL);</span>
              try {
<span class="nc" id="L276">                ResultSet rs =</span>
<span class="nc" id="L277">                    sdkClient.executeStatement(</span>
                        showColumnsSQL,
<span class="nc" id="L279">                        session.getComputeResource(),</span>
                        new HashMap&lt;Integer, ImmutableSqlParameter&gt;(),
                        StatementType.METADATA,
                        session,
                        null /* parentStatement */);
<span class="nc bnc" id="L284" title="All 2 branches missed.">                while (rs.next()) {</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                  if (rs.getString(1).matches(columnNamePattern)) {</span>
<span class="nc" id="L286">                    rows.add(</span>
<span class="nc" id="L287">                        Arrays.asList(</span>
<span class="nc" id="L288">                            combination[0], combination[1], combination[2], rs.getString(1)));</span>
                  }
                }
<span class="nc" id="L291">              } catch (SQLException e) {</span>
<span class="nc" id="L292">                throw new RuntimeException(e);</span>
<span class="nc" id="L293">              }</span>
<span class="nc" id="L294">            }</span>
<span class="nc" id="L295">          });</span>
    }
<span class="nc" id="L297">    executorService.shutdown();</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">    while (!executorService.isTerminated()) {</span>
      // wait
    }
    // TODO: some columns are missing from result set, determine how to fill those
<span class="nc" id="L302">    rows.sort(</span>
<span class="nc" id="L303">        Comparator.comparing((List&lt;Object&gt; i) -&gt; i.get(0).toString())</span>
<span class="nc" id="L304">            .thenComparing(i -&gt; i.get(1).toString())</span>
<span class="nc" id="L305">            .thenComparing(i -&gt; i.get(2).toString()));</span>
<span class="nc" id="L306">    return new DatabricksResultSet(</span>
<span class="nc" id="L307">        new StatementStatus().setState(StatementState.SUCCEEDED),</span>
        &quot;metadata-statement&quot;,
<span class="nc" id="L309">        Arrays.asList(&quot;TABLE_CAT&quot;, &quot;TABLE_SCHEM&quot;, &quot;TABLE_NAME&quot;, &quot;COLUMN_NAME&quot;),</span>
<span class="nc" id="L310">        Arrays.asList(&quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;, &quot;VARCHAR&quot;),</span>
<span class="nc" id="L311">        Arrays.asList(Types.VARCHAR, Types.VARCHAR, Types.VARCHAR, Types.VARCHAR),</span>
<span class="nc" id="L312">        Arrays.asList(128, 128, 128, 128),</span>
        rows,
        StatementType.METADATA);
  }

  @Override
  public DatabricksResultSet listFunctions(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String functionNamePattern)
      throws SQLException {
<span class="nc" id="L324">    return null;</span>
  }

  @Override
  public DatabricksResultSet listPrimaryKeys(
      IDatabricksSession session, String catalog, String schema, String table) throws SQLException {
<span class="nc" id="L330">    return null;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>