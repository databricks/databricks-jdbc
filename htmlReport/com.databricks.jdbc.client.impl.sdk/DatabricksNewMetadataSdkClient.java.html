<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksNewMetadataSdkClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.client.impl.sdk</a> &gt; <span class="el_source">DatabricksNewMetadataSdkClient.java</span></div><h1>DatabricksNewMetadataSdkClient.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.client.impl.sdk;

import static com.databricks.jdbc.client.impl.helper.MetadataResultConstants.DEFAULT_TABLE_TYPES;
import static com.databricks.jdbc.client.impl.sdk.ResultConstants.TYPE_INFO_RESULT;

import com.databricks.jdbc.client.DatabricksMetadataClient;
import com.databricks.jdbc.client.StatementType;
import com.databricks.jdbc.client.impl.helper.CommandBuilder;
import com.databricks.jdbc.client.impl.helper.CommandName;
import com.databricks.jdbc.client.impl.helper.MetadataResultSetBuilder;
import com.databricks.jdbc.commons.MetricsList;
import com.databricks.jdbc.core.*;
import com.databricks.jdbc.telemetry.DatabricksMetrics;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.*;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

/**
 * This is for the new SQL commands added in runtime. Note that the DatabricksMetadataSdkClient will
 * be replaced by this class once runtime code is merged and this class is tested end to end.
 * https://docs.google.com/document/d/1E28o7jyPIp6_byZHGD5Eyc4uwGVSydX5o9PaiSY1V4s/edit#heading=h.681k0yimshae
 * Tracking bug for replacement: (PECO-1502)
 */
public class DatabricksNewMetadataSdkClient implements DatabricksMetadataClient {

<span class="fc" id="L28">  private static final Logger LOGGER = LogManager.getLogger(DatabricksNewMetadataSdkClient.class);</span>
  private final DatabricksSdkClient sdkClient;

<span class="fc" id="L31">  public DatabricksNewMetadataSdkClient(DatabricksSdkClient sdkClient) {</span>
<span class="fc" id="L32">    this.sdkClient = sdkClient;</span>
<span class="fc" id="L33">  }</span>

  @Override
  public DatabricksResultSet listTypeInfo(IDatabricksSession session) {
<span class="fc" id="L37">    LOGGER.debug(&quot;public ResultSet getTypeInfo()&quot;);</span>
<span class="fc" id="L38">    return TYPE_INFO_RESULT;</span>
  }

  @Override
  public DatabricksResultSet listCatalogs(IDatabricksSession session) throws SQLException {
<span class="fc" id="L43">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L44">    CommandBuilder commandBuilder = new CommandBuilder(session);</span>
<span class="fc" id="L45">    String SQL = commandBuilder.getSQLString(CommandName.LIST_CATALOGS);</span>
<span class="fc" id="L46">    LOGGER.debug(&quot;SQL command to fetch catalogs: {}&quot;, SQL);</span>
<span class="fc" id="L47">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L48">        MetadataResultSetBuilder.getCatalogsResult(</span>
<span class="fc" id="L49">            getResultSet(SQL, session, StatementType.METADATA));</span>
<span class="fc" id="L50">    DatabricksMetrics.record(</span>
<span class="fc" id="L51">        MetricsList.LIST_CATALOGS_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L52">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listSchemas(
      IDatabricksSession session, String catalog, String schemaNamePattern) throws SQLException {
<span class="fc" id="L58">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L59">    CommandBuilder commandBuilder =</span>
<span class="fc" id="L60">        new CommandBuilder(catalog, session).setSchemaPattern(schemaNamePattern);</span>
<span class="fc" id="L61">    String SQL = commandBuilder.getSQLString(CommandName.LIST_SCHEMAS);</span>
<span class="fc" id="L62">    LOGGER.debug(&quot;SQL command to fetch schemas: {}&quot;, SQL);</span>
<span class="fc" id="L63">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L64">        MetadataResultSetBuilder.getSchemasResult(</span>
<span class="fc" id="L65">            getResultSet(SQL, session, StatementType.METADATA), catalog);</span>
<span class="fc" id="L66">    DatabricksMetrics.record(</span>
<span class="fc" id="L67">        MetricsList.LIST_SCHEMAS_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L68">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listTables(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String tableNamePattern,
      String[] tableTypes)
      throws SQLException {
<span class="fc" id="L79">    tableTypes =</span>
<span class="fc" id="L80">        Optional.ofNullable(tableTypes)</span>
<span class="pc bnc" id="L81" title="All 2 branches missed.">            .filter(types -&gt; types.length &gt; 0)</span>
<span class="fc" id="L82">            .orElse(DEFAULT_TABLE_TYPES);</span>
<span class="fc" id="L83">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L84">    CommandBuilder commandBuilder =</span>
        new CommandBuilder(catalog, session)
<span class="fc" id="L86">            .setSchemaPattern(schemaNamePattern)</span>
<span class="fc" id="L87">            .setTablePattern(tableNamePattern);</span>
<span class="fc" id="L88">    String SQL = commandBuilder.getSQLString(CommandName.LIST_TABLES);</span>
<span class="fc" id="L89">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L90">        MetadataResultSetBuilder.getTablesResult(</span>
<span class="fc" id="L91">            getResultSet(SQL, session, StatementType.METADATA), tableTypes);</span>
<span class="fc" id="L92">    DatabricksMetrics.record(</span>
<span class="fc" id="L93">        MetricsList.LIST_TABLES_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L94">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listTableTypes(IDatabricksSession session) throws SQLException {
<span class="fc" id="L99">    LOGGER.debug(&quot;Returning list of table types.&quot;);</span>
<span class="fc" id="L100">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L101">    DatabricksResultSet resultSet = MetadataResultSetBuilder.getTableTypesResult();</span>
<span class="fc" id="L102">    DatabricksMetrics.record(</span>
<span class="fc" id="L103">        MetricsList.LIST_TABLE_TYPES_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L104">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listColumns(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String tableNamePattern,
      String columnNamePattern)
      throws SQLException {
<span class="fc" id="L115">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L116">    CommandBuilder commandBuilder =</span>
        new CommandBuilder(catalog, session)
<span class="fc" id="L118">            .setSchemaPattern(schemaNamePattern)</span>
<span class="fc" id="L119">            .setTablePattern(tableNamePattern)</span>
<span class="fc" id="L120">            .setColumnPattern(columnNamePattern);</span>
<span class="fc" id="L121">    String SQL = commandBuilder.getSQLString(CommandName.LIST_COLUMNS);</span>
<span class="fc" id="L122">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L123">        MetadataResultSetBuilder.getColumnsResult(getResultSet(SQL, session, StatementType.QUERY));</span>
<span class="fc" id="L124">    DatabricksMetrics.record(</span>
<span class="fc" id="L125">        MetricsList.LIST_COLUMNS_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L126">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listFunctions(
      IDatabricksSession session,
      String catalog,
      String schemaNamePattern,
      String functionNamePattern)
      throws SQLException {
<span class="fc" id="L136">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L137">    CommandBuilder commandBuilder =</span>
        new CommandBuilder(catalog, session)
<span class="fc" id="L139">            .setSchemaPattern(schemaNamePattern)</span>
<span class="fc" id="L140">            .setFunctionPattern(functionNamePattern);</span>
<span class="fc" id="L141">    String SQL = commandBuilder.getSQLString(CommandName.LIST_FUNCTIONS);</span>
<span class="fc" id="L142">    LOGGER.debug(&quot;SQL command to fetch functions: {}&quot;, SQL);</span>
<span class="fc" id="L143">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L144">        MetadataResultSetBuilder.getFunctionsResult(</span>
<span class="fc" id="L145">            getResultSet(SQL, session, StatementType.QUERY), catalog);</span>
<span class="fc" id="L146">    DatabricksMetrics.record(</span>
<span class="fc" id="L147">        MetricsList.LIST_FUNCTIONS_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L148">    return resultSet;</span>
  }

  @Override
  public DatabricksResultSet listPrimaryKeys(
      IDatabricksSession session, String catalog, String schema, String table) throws SQLException {
<span class="fc" id="L154">    long startTime = System.currentTimeMillis();</span>
<span class="fc" id="L155">    CommandBuilder commandBuilder =</span>
<span class="fc" id="L156">        new CommandBuilder(catalog, session).setSchema(schema).setTable(table);</span>
<span class="fc" id="L157">    String SQL = commandBuilder.getSQLString(CommandName.LIST_PRIMARY_KEYS);</span>
<span class="fc" id="L158">    LOGGER.debug(&quot;SQL command to fetch primary keys: {}&quot;, SQL);</span>
<span class="fc" id="L159">    DatabricksResultSet resultSet =</span>
<span class="fc" id="L160">        MetadataResultSetBuilder.getPrimaryKeysResult(</span>
<span class="fc" id="L161">            getResultSet(SQL, session, StatementType.METADATA));</span>
<span class="fc" id="L162">    DatabricksMetrics.record(</span>
<span class="fc" id="L163">        MetricsList.LIST_PRIMARY_KEYS_METADATA_SEA.name(), System.currentTimeMillis() - startTime);</span>
<span class="fc" id="L164">    return resultSet;</span>
  }

  private ResultSet getResultSet(
      String SQL, IDatabricksSession session, StatementType statementType) throws SQLException {
<span class="fc" id="L169">    return sdkClient.executeStatement(</span>
        SQL,
<span class="fc" id="L171">        session.getComputeResource(),</span>
        new HashMap&lt;Integer, ImmutableSqlParameter&gt;(),
        statementType,
        session,
        null /* parentStatement */);
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>