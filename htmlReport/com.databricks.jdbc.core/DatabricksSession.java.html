<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksSession.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.core</a> &gt; <span class="el_source">DatabricksSession.java</span></div><h1>DatabricksSession.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.core;

import com.databricks.jdbc.client.DatabricksClient;
import com.databricks.jdbc.client.DatabricksClientType;
import com.databricks.jdbc.client.DatabricksMetadataClient;
import com.databricks.jdbc.client.impl.sdk.DatabricksMetadataSdkClient;
import com.databricks.jdbc.client.impl.sdk.DatabricksNewMetadataSdkClient;
import com.databricks.jdbc.client.impl.sdk.DatabricksSdkClient;
import com.databricks.jdbc.client.impl.thrift.DatabricksThriftServiceClient;
import com.databricks.jdbc.core.types.CompressionType;
import com.databricks.jdbc.core.types.ComputeResource;
import com.databricks.jdbc.driver.IDatabricksConnectionContext;
import com.databricks.sdk.support.ToStringer;
import com.google.common.annotations.VisibleForTesting;
import java.util.HashMap;
import java.util.Map;
import javax.annotation.Nullable;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

/** Implementation for Session interface, which maintains an underlying session in SQL Gateway. */
public class DatabricksSession implements IDatabricksSession {

<span class="fc" id="L24">  private static final Logger LOGGER = LogManager.getLogger(DatabricksSession.class);</span>
  private final DatabricksClient databricksClient;
  private final DatabricksMetadataClient databricksMetadataClient;
  private final ComputeResource computeResource;

  private boolean isSessionOpen;
  private ImmutableSessionInfo sessionInfo;

  // For context based commands
  private String catalog;

  private String schema;

  private Map&lt;String, String&gt; sessionConfigs;

  private Map&lt;String, String&gt; clientInfoProperties;
  private CompressionType compressionType;

  private IDatabricksConnectionContext connectionContext;

  /**
   * Creates an instance of Databricks session for given connection context
   *
   * @param connectionContext underlying connection context
   */
  public DatabricksSession(IDatabricksConnectionContext connectionContext)
<span class="fc" id="L50">      throws DatabricksSQLException {</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">    if (connectionContext.getClientType() == DatabricksClientType.THRIFT) {</span>
<span class="nc" id="L52">      this.databricksClient = new DatabricksThriftServiceClient(connectionContext);</span>
<span class="nc" id="L53">      this.databricksMetadataClient = null;</span>
    } else {
<span class="fc" id="L55">      this.databricksClient = new DatabricksSdkClient(connectionContext);</span>
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">      if (connectionContext.getUseLegacyMetadata()) {</span>
<span class="nc" id="L57">        this.databricksMetadataClient =</span>
            new DatabricksMetadataSdkClient((DatabricksSdkClient) databricksClient);
      } else {
<span class="fc" id="L60">        this.databricksMetadataClient =</span>
            new DatabricksNewMetadataSdkClient((DatabricksSdkClient) databricksClient);
      }
    }
<span class="fc" id="L64">    this.isSessionOpen = false;</span>
<span class="fc" id="L65">    this.sessionInfo = null;</span>
<span class="fc" id="L66">    this.computeResource = connectionContext.getComputeResource();</span>
<span class="fc" id="L67">    this.catalog = connectionContext.getCatalog();</span>
<span class="fc" id="L68">    this.schema = connectionContext.getSchema();</span>
<span class="fc" id="L69">    this.sessionConfigs = connectionContext.getSessionConfigs();</span>
<span class="fc" id="L70">    this.clientInfoProperties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L71">    this.compressionType = connectionContext.getCompressionType();</span>
<span class="fc" id="L72">    this.connectionContext = connectionContext;</span>
<span class="fc" id="L73">  }</span>

  /** Constructor method to be used for mocking in a test case. */
  @VisibleForTesting
  DatabricksSession(
      IDatabricksConnectionContext connectionContext, DatabricksClient databricksClient)
<span class="fc" id="L79">      throws DatabricksSQLException {</span>
<span class="fc" id="L80">    this.databricksClient = databricksClient;</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">    if (databricksClient instanceof DatabricksThriftServiceClient) {</span>
<span class="fc" id="L82">      this.databricksMetadataClient = null;</span>
    } else {
<span class="fc" id="L84">      this.databricksMetadataClient =</span>
          new DatabricksMetadataSdkClient((DatabricksSdkClient) databricksClient);
    }
<span class="fc" id="L87">    this.isSessionOpen = false;</span>
<span class="fc" id="L88">    this.sessionInfo = null;</span>
<span class="fc" id="L89">    this.computeResource = connectionContext.getComputeResource();</span>
<span class="fc" id="L90">    this.catalog = connectionContext.getCatalog();</span>
<span class="fc" id="L91">    this.schema = connectionContext.getSchema();</span>
<span class="fc" id="L92">    this.sessionConfigs = connectionContext.getSessionConfigs();</span>
<span class="fc" id="L93">    this.clientInfoProperties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L94">    this.compressionType = connectionContext.getCompressionType();</span>
<span class="fc" id="L95">    this.connectionContext = connectionContext;</span>
<span class="fc" id="L96">  }</span>

  @Nullable
  @Override
  public String getSessionId() {
<span class="fc" id="L101">    LOGGER.debug(&quot;public String getSessionId()&quot;);</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">    return (isSessionOpen) ? sessionInfo.sessionId() : null;</span>
  }

  @Override
  @Nullable
  public ImmutableSessionInfo getSessionInfo() {
<span class="fc" id="L108">    LOGGER.debug(&quot;public String getSessionInfo()&quot;);</span>
<span class="fc" id="L109">    return sessionInfo;</span>
  }

  @Override
  public ComputeResource getComputeResource() {
<span class="fc" id="L114">    LOGGER.debug(&quot;public String getWarehouseId()&quot;);</span>
<span class="fc" id="L115">    return this.computeResource;</span>
  }

  @Override
  public CompressionType getCompressionType() {
<span class="fc" id="L120">    LOGGER.debug(&quot;public String getWarehouseId()&quot;);</span>
<span class="fc" id="L121">    return compressionType;</span>
  }

  @Override
  public boolean isOpen() {
<span class="fc" id="L126">    LOGGER.debug(&quot;public boolean isOpen()&quot;);</span>
    // TODO: check for expired sessions
<span class="fc" id="L128">    return isSessionOpen;</span>
  }

  @Override
  public void open() throws DatabricksSQLException {
<span class="fc" id="L133">    LOGGER.debug(&quot;public void open()&quot;);</span>
    // TODO: check for expired sessions
<span class="fc" id="L135">    synchronized (this) {</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">      if (!isSessionOpen) {</span>
        // TODO: handle errors
<span class="fc" id="L138">        this.sessionInfo =</span>
<span class="fc" id="L139">            databricksClient.createSession(</span>
                this.computeResource, this.catalog, this.schema, this.sessionConfigs);
<span class="fc" id="L141">        this.isSessionOpen = true;</span>
      }
<span class="fc" id="L143">    }</span>
<span class="fc" id="L144">  }</span>

  @Override
  public void close() throws DatabricksSQLException {
<span class="fc" id="L148">    LOGGER.debug(&quot;public void close()&quot;);</span>
    // TODO: check for any pending query executions
<span class="fc" id="L150">    synchronized (this) {</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">      if (isSessionOpen) {</span>
        // TODO: handle closed connections by server
<span class="fc" id="L153">        databricksClient.deleteSession(this, computeResource);</span>
<span class="fc" id="L154">        this.sessionInfo = null;</span>
<span class="fc" id="L155">        this.isSessionOpen = false;</span>
      }
<span class="fc" id="L157">    }</span>
<span class="fc" id="L158">  }</span>

  @Override
  public DatabricksClient getDatabricksClient() {
<span class="fc" id="L162">    LOGGER.debug(&quot;public DatabricksClient getDatabricksClient()&quot;);</span>
<span class="fc" id="L163">    return databricksClient;</span>
  }

  @Override
  public DatabricksMetadataClient getDatabricksMetadataClient() {
<span class="fc" id="L168">    LOGGER.debug(&quot;public DatabricksClient getDatabricksMetadataClient()&quot;);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">    if (this.connectionContext.getClientType() == DatabricksClientType.THRIFT) {</span>
<span class="fc" id="L170">      return (DatabricksMetadataClient) databricksClient;</span>
    }
<span class="fc" id="L172">    return databricksMetadataClient;</span>
  }

  @Override
  public String getCatalog() {
<span class="fc" id="L177">    LOGGER.debug(&quot;public String getCatalog()&quot;);</span>
<span class="fc" id="L178">    return catalog;</span>
  }

  @Override
  public void setCatalog(String catalog) {
<span class="fc" id="L183">    LOGGER.debug(&quot;public void setCatalog(String catalog = {})&quot;, catalog);</span>
<span class="fc" id="L184">    this.catalog = catalog;</span>
<span class="fc" id="L185">  }</span>

  @Override
  public String getSchema() {
<span class="fc" id="L189">    LOGGER.debug(&quot;public String getSchema()&quot;);</span>
<span class="fc" id="L190">    return schema;</span>
  }

  @Override
  public void setSchema(String schema) {
<span class="fc" id="L195">    LOGGER.debug(&quot;public void setSchema(String schema = {})&quot;, schema);</span>
<span class="fc" id="L196">    this.schema = schema;</span>
<span class="fc" id="L197">  }</span>

  @Override
  public String toString() {
<span class="fc" id="L201">    return (new ToStringer(DatabricksSession.class))</span>
<span class="fc" id="L202">        .add(&quot;compute&quot;, this.computeResource.toString())</span>
<span class="fc" id="L203">        .add(&quot;catalog&quot;, this.catalog)</span>
<span class="fc" id="L204">        .add(&quot;schema&quot;, this.schema)</span>
<span class="fc" id="L205">        .add(&quot;sessionID&quot;, this.getSessionId())</span>
<span class="fc" id="L206">        .toString();</span>
  }

  @Override
  public Map&lt;String, String&gt; getSessionConfigs() {
<span class="fc" id="L211">    LOGGER.debug(&quot;public Map&lt;String, String&gt; getSessionConfigs()&quot;);</span>
<span class="fc" id="L212">    return sessionConfigs;</span>
  }

  @Override
  public void setSessionConfig(String name, String value) {
<span class="fc" id="L217">    LOGGER.debug(&quot;public void setSessionConfig(String name = {}, String value = {})&quot;, name, value);</span>
<span class="fc" id="L218">    sessionConfigs.put(name, value);</span>
<span class="fc" id="L219">  }</span>

  @Override
  public Map&lt;String, String&gt; getClientInfoProperties() {
<span class="fc" id="L223">    LOGGER.debug(&quot;public Map&lt;String, String&gt; getClientInfoProperties()&quot;);</span>
<span class="fc" id="L224">    return clientInfoProperties;</span>
  }

  @Override
  public void setClientInfoProperty(String name, String value) {
<span class="fc" id="L229">    LOGGER.debug(</span>
        &quot;public void setClientInfoProperty(String name = {}, String value = {})&quot;, name, value);
<span class="fc" id="L231">    clientInfoProperties.put(name, value);</span>
<span class="fc" id="L232">  }</span>

  @Override
  public IDatabricksConnectionContext getConnectionContext() {
<span class="fc" id="L236">    return this.connectionContext;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>