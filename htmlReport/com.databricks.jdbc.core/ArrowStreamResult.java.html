<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ArrowStreamResult.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.core</a> &gt; <span class="el_source">ArrowStreamResult.java</span></div><h1>ArrowStreamResult.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.core;

import static com.databricks.jdbc.client.impl.thrift.commons.DatabricksThriftHelper.getTypeFromTypeDesc;

import com.databricks.jdbc.client.IDatabricksHttpClient;
import com.databricks.jdbc.client.impl.thrift.generated.TColumnDesc;
import com.databricks.jdbc.client.impl.thrift.generated.TGetResultSetMetadataResp;
import com.databricks.jdbc.client.impl.thrift.generated.TRowSet;
import com.databricks.jdbc.client.sqlexec.ResultData;
import com.databricks.jdbc.client.sqlexec.ResultManifest;
import com.databricks.sdk.service.sql.ColumnInfo;
import com.databricks.sdk.service.sql.ColumnInfoTypeName;
import com.google.common.annotations.VisibleForTesting;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;

class ArrowStreamResult implements IExecutionResult {

  private IDatabricksSession session;
  private ChunkDownloader chunkDownloader;
  private ChunkExtractor chunkExtractor;

  private long currentRowIndex;

  private final boolean isInlineArrow;

  private boolean isClosed;

  private ArrowResultChunk.ArrowResultChunkIterator chunkIterator;

  List&lt;ColumnInfo&gt; columnInfos;

  ArrowStreamResult(
      ResultManifest resultManifest,
      ResultData resultData,
      String statementId,
      IDatabricksSession session) {
<span class="fc" id="L39">    this(</span>
        resultManifest,
        new ChunkDownloader(
            statementId,
            resultManifest,
            resultData,
            session,
<span class="fc" id="L46">            session.getConnectionContext().getCloudFetchThreadPoolSize()),</span>
        session);
<span class="fc" id="L48">  }</span>

  ArrowStreamResult(
      TGetResultSetMetadataResp resultManifest,
      TRowSet resultData,
      boolean isInlineArrow,
      String parentStatementId,
      IDatabricksSession session)
      throws DatabricksParsingException {
<span class="fc" id="L57">    this(resultManifest, resultData, isInlineArrow, parentStatementId, session, null);</span>
<span class="fc" id="L58">  }</span>

  ArrowStreamResult(
      TGetResultSetMetadataResp resultManifest,
      TRowSet resultData,
      boolean isInlineArrow,
      String statementId,
      IDatabricksSession session,
      IDatabricksHttpClient httpClient)
<span class="fc" id="L67">      throws DatabricksParsingException {</span>
<span class="fc" id="L68">    this.chunkDownloader = null;</span>
<span class="fc" id="L69">    setColumnInfo(resultManifest);</span>
<span class="fc" id="L70">    this.currentRowIndex = -1;</span>
<span class="fc" id="L71">    this.isClosed = false;</span>
<span class="fc" id="L72">    this.isInlineArrow = isInlineArrow;</span>
<span class="fc" id="L73">    this.chunkIterator = null;</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">    if (isInlineArrow) {</span>
<span class="fc" id="L75">      this.chunkExtractor = new ChunkExtractor(resultData.getArrowBatches(), resultManifest);</span>
<span class="fc" id="L76">      this.chunkDownloader = null;</span>
    } else {
<span class="fc bfc" id="L78" title="All 2 branches covered.">      if (httpClient != null) { // This is to aid testing</span>
<span class="fc" id="L79">        this.chunkDownloader =</span>
            new ChunkDownloader(
                statementId,
                resultData,
                session,
                httpClient,
<span class="fc" id="L85">                session.getConnectionContext().getCloudFetchThreadPoolSize());</span>
      } else {
<span class="fc" id="L87">        this.chunkDownloader =</span>
            new ChunkDownloader(
                statementId,
                resultData,
                session,
<span class="fc" id="L92">                session.getConnectionContext().getCloudFetchThreadPoolSize());</span>
      }
<span class="fc" id="L94">      this.chunkExtractor = null;</span>
    }
<span class="fc" id="L96">  }</span>

  private void setColumnInfo(TGetResultSetMetadataResp resultManifest) {
<span class="fc" id="L99">    this.columnInfos = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">    if (resultManifest.getSchema() == null) {</span>
<span class="fc" id="L101">      return;</span>
    }
<span class="fc bfc" id="L103" title="All 2 branches covered.">    for (TColumnDesc columnInfo : resultManifest.getSchema().getColumns()) {</span>
<span class="fc" id="L104">      this.columnInfos.add(</span>
<span class="fc" id="L105">          new ColumnInfo().setTypeName(getTypeFromTypeDesc(columnInfo.getTypeDesc())));</span>
<span class="fc" id="L106">    }</span>
<span class="fc" id="L107">  }</span>

  @VisibleForTesting
  ArrowStreamResult(
      ResultManifest resultManifest,
      ResultData resultData,
      String statementId,
      IDatabricksSession session,
      IDatabricksHttpClient httpClient) {
<span class="fc" id="L116">    this(</span>
        resultManifest,
        new ChunkDownloader(
            statementId,
            resultManifest,
            resultData,
            session,
            httpClient,
<span class="fc" id="L124">            session.getConnectionContext().getCloudFetchThreadPoolSize()),</span>
        session);
<span class="fc" id="L126">  }</span>

  private ArrowStreamResult(
<span class="fc" id="L129">      ResultManifest resultManifest, ChunkDownloader chunkDownloader, IDatabricksSession session) {</span>
<span class="fc" id="L130">    this.session = session;</span>
<span class="fc" id="L131">    this.isInlineArrow = false;</span>
<span class="fc" id="L132">    this.chunkDownloader = chunkDownloader;</span>
<span class="fc" id="L133">    this.columnInfos =</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        resultManifest.getSchema().getColumnCount() == 0</span>
<span class="fc" id="L135">            ? new ArrayList&lt;&gt;()</span>
<span class="fc" id="L136">            : new ArrayList&lt;&gt;(resultManifest.getSchema().getColumns());</span>
<span class="fc" id="L137">    this.currentRowIndex = -1;</span>
<span class="fc" id="L138">    this.isClosed = false;</span>
<span class="fc" id="L139">    this.chunkIterator = null;</span>
<span class="fc" id="L140">  }</span>

  @Override
  public Object getObject(int columnIndex) throws SQLException {
    // we have two types:
    // 1. Required type via the metadata
    // 2. Interpreted type while reading from the arrow file into the record batches
    // We need to convert the interpreted type into the required type before returning the object
<span class="fc" id="L148">    ColumnInfoTypeName requiredType = columnInfos.get(columnIndex).getTypeName();</span>
<span class="fc" id="L149">    Object unconvertedObject = this.chunkIterator.getColumnObjectAtCurrentRow(columnIndex);</span>
<span class="fc" id="L150">    return ArrowToJavaObjectConverter.convert(unconvertedObject, requiredType);</span>
  }

  @Override
  public long getCurrentRow() {
<span class="fc" id="L155">    return this.currentRowIndex;</span>
  }

  @Override
  public boolean next() throws DatabricksSQLException {
<span class="fc bfc" id="L160" title="All 2 branches covered.">    if (!hasNext()) {</span>
<span class="fc" id="L161">      return false;</span>
    }
<span class="fc" id="L163">    this.currentRowIndex++;</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">    if (isInlineArrow) {</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">      if (chunkIterator == null) {</span>
<span class="fc" id="L166">        this.chunkIterator = this.chunkExtractor.next().getChunkIterator();</span>
      }
<span class="fc" id="L168">      return chunkIterator.nextRow();</span>
    }
    // Either this is first chunk or we are crossing chunk boundary
<span class="fc bfc" id="L171" title="All 4 branches covered.">    if (this.chunkIterator == null || !this.chunkIterator.hasNextRow()) {</span>
<span class="fc" id="L172">      this.chunkDownloader.next();</span>
<span class="fc" id="L173">      this.chunkIterator = this.chunkDownloader.getChunk().getChunkIterator();</span>
<span class="fc" id="L174">      return chunkIterator.nextRow();</span>
    }
    // Traversing within a chunk
<span class="fc" id="L177">    return this.chunkIterator.nextRow();</span>
  }

  @Override
  public boolean hasNext() {
<span class="fc bfc" id="L182" title="All 2 branches covered.">    if (isClosed) {</span>
<span class="fc" id="L183">      return false;</span>
    }

    // Check if there are any more rows available in the current chunk
<span class="fc bfc" id="L187" title="All 4 branches covered.">    if (chunkIterator != null &amp;&amp; chunkIterator.hasNextRow()) {</span>
<span class="fc" id="L188">      return true;</span>
    }

    // For inline arrow, check if the chunk extractor has more chunks
    // Otherwise, check the chunk downloader
<span class="fc bfc" id="L193" title="All 2 branches covered.">    return isInlineArrow ? this.chunkExtractor.hasNext() : this.chunkDownloader.hasNextChunk();</span>
  }

  @Override
  public void close() {
<span class="fc" id="L198">    this.isClosed = true;</span>
<span class="fc bfc" id="L199" title="All 2 branches covered.">    if (isInlineArrow) {</span>
<span class="fc" id="L200">      this.chunkExtractor.releaseChunk();</span>
    } else {
<span class="fc" id="L202">      this.chunkDownloader.releaseAllChunks();</span>
    }
<span class="fc" id="L204">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>