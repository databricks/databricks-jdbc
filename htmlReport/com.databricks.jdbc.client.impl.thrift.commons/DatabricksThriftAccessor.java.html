<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksThriftAccessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.client.impl.thrift.commons</a> &gt; <span class="el_source">DatabricksThriftAccessor.java</span></div><h1>DatabricksThriftAccessor.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.client.impl.thrift.commons;

import static com.databricks.jdbc.client.impl.thrift.commons.DatabricksThriftHelper.*;
import static com.databricks.jdbc.commons.EnvironmentVariables.*;

import com.databricks.jdbc.client.DatabricksHttpException;
import com.databricks.jdbc.client.StatementType;
import com.databricks.jdbc.client.http.DatabricksHttpClient;
import com.databricks.jdbc.client.impl.thrift.generated.*;
import com.databricks.jdbc.commons.CommandName;
import com.databricks.jdbc.core.*;
import com.databricks.jdbc.driver.IDatabricksConnectionContext;
import com.databricks.sdk.core.DatabricksConfig;
import com.google.common.annotations.VisibleForTesting;
import java.sql.SQLException;
import java.util.Map;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.thrift.TBase;
import org.apache.thrift.TException;
import org.apache.thrift.protocol.TBinaryProtocol;

public class DatabricksThriftAccessor {

<span class="fc" id="L25">  private static final Logger LOGGER = LogManager.getLogger(DatabricksThriftAccessor.class);</span>
  private final DatabricksConfig databricksConfig;
  private final TCLIService.Client thriftClient;
  private final Boolean enableDirectResults;
<span class="fc" id="L29">  private static final TSparkGetDirectResults DEFAULT_DIRECT_RESULTS =</span>
<span class="fc" id="L30">      new TSparkGetDirectResults().setMaxRows(DEFAULT_ROW_LIMIT).setMaxBytes(DEFAULT_BYTE_LIMIT);</span>

  public DatabricksThriftAccessor(IDatabricksConnectionContext connectionContext)
<span class="nc" id="L33">      throws DatabricksParsingException {</span>
<span class="nc" id="L34">    DatabricksHttpTTransport transport =</span>
        new DatabricksHttpTTransport(
<span class="nc" id="L36">            DatabricksHttpClient.getInstance(connectionContext),</span>
<span class="nc" id="L37">            connectionContext.getEndpointURL());</span>

<span class="nc" id="L39">    enableDirectResults = connectionContext.getDirectResultMode();</span>
<span class="nc" id="L40">    this.databricksConfig = new OAuthAuthenticator(connectionContext).getDatabricksConfig();</span>
<span class="nc" id="L41">    Map&lt;String, String&gt; authHeaders = databricksConfig.authenticate();</span>
<span class="nc" id="L42">    transport.setCustomHeaders(authHeaders);</span>
<span class="nc" id="L43">    TBinaryProtocol protocol = new TBinaryProtocol(transport);</span>
<span class="nc" id="L44">    this.thriftClient = new TCLIService.Client(protocol);</span>
<span class="nc" id="L45">  }</span>

  @VisibleForTesting
  DatabricksThriftAccessor(
      TCLIService.Client client,
      DatabricksConfig config,
<span class="fc" id="L51">      IDatabricksConnectionContext connectionContext) {</span>
<span class="fc" id="L52">    this.databricksConfig = config;</span>
<span class="fc" id="L53">    this.thriftClient = client;</span>
<span class="fc" id="L54">    this.enableDirectResults = connectionContext.getDirectResultMode();</span>
<span class="fc" id="L55">  }</span>

  public TBase getThriftResponse(
      TBase request, CommandName commandName, IDatabricksStatement parentStatement)
      throws DatabricksSQLException {
    /*Todo list :
     *  1. Test out metadata operations.
     *  2. Handle compression
     * */
<span class="fc" id="L64">    LOGGER.debug(</span>
        &quot;Fetching thrift response for request {}, CommandName {}&quot;,
<span class="fc" id="L66">        request.toString(),</span>
<span class="fc" id="L67">        commandName.name());</span>
<span class="fc" id="L68">    refreshHeadersIfRequired();</span>
    try {
<span class="pc bpc" id="L70" title="1 of 11 branches missed.">      switch (commandName) {</span>
        case OPEN_SESSION:
<span class="fc" id="L72">          return thriftClient.OpenSession((TOpenSessionReq) request);</span>
        case CLOSE_SESSION:
<span class="fc" id="L74">          return thriftClient.CloseSession((TCloseSessionReq) request);</span>
        case LIST_PRIMARY_KEYS:
<span class="fc" id="L76">          return listPrimaryKeys((TGetPrimaryKeysReq) request);</span>
        case LIST_FUNCTIONS:
<span class="fc" id="L78">          return listFunctions((TGetFunctionsReq) request);</span>
        case LIST_SCHEMAS:
<span class="fc" id="L80">          return listSchemas((TGetSchemasReq) request);</span>
        case LIST_COLUMNS:
<span class="fc" id="L82">          return listColumns((TGetColumnsReq) request);</span>
        case LIST_CATALOGS:
<span class="fc" id="L84">          return getCatalogs((TGetCatalogsReq) request);</span>
        case LIST_TABLES:
<span class="fc" id="L86">          return getTables((TGetTablesReq) request);</span>
        case LIST_TABLE_TYPES:
<span class="fc" id="L88">          return getTableTypes((TGetTableTypesReq) request);</span>
        case LIST_TYPE_INFO:
<span class="fc" id="L90">          return getTypeInfo((TGetTypeInfoReq) request);</span>
        default:
<span class="nc" id="L92">          String errorMessage =</span>
<span class="nc" id="L93">              String.format(</span>
                  &quot;No implementation for fetching thrift response for CommandName {%s}.  Request {%s}&quot;,
<span class="nc" id="L95">                  commandName, request.toString());</span>
<span class="nc" id="L96">          LOGGER.error(errorMessage);</span>
<span class="nc" id="L97">          throw new DatabricksSQLFeatureNotSupportedException(errorMessage);</span>
      }
<span class="fc" id="L99">    } catch (TException | SQLException e) {</span>
<span class="fc" id="L100">      String errorMessage =</span>
<span class="fc" id="L101">          String.format(</span>
              &quot;Error while receiving response from Thrift server. Request {%s}, Error {%s}&quot;,
<span class="fc" id="L103">              request.toString(), e.toString());</span>
<span class="fc" id="L104">      LOGGER.error(errorMessage);</span>
<span class="fc" id="L105">      throw new DatabricksSQLException(errorMessage, e);</span>
    }
  }

  public TFetchResultsResp getResultSetResp(TOperationHandle operationHandle, String context)
      throws DatabricksHttpException {
<span class="nc" id="L111">    refreshHeadersIfRequired();</span>
<span class="nc" id="L112">    return getResultSetResp(</span>
        TStatusCode.SUCCESS_STATUS, operationHandle, context, DEFAULT_ROW_LIMIT, false);
  }

  private TFetchResultsResp getResultSetResp(
      TStatusCode responseCode,
      TOperationHandle operationHandle,
      String context,
      int maxRows,
      boolean fetchMetadata)
      throws DatabricksHttpException {
<span class="fc" id="L123">    verifySuccessStatus(responseCode, context);</span>
<span class="fc" id="L124">    TFetchResultsReq request =</span>
        new TFetchResultsReq()
<span class="fc" id="L126">            .setOperationHandle(operationHandle)</span>
<span class="fc" id="L127">            .setIncludeResultSetMetadata(true)</span>
<span class="fc" id="L128">            .setFetchType((short) 0) // 0 represents Query output. 1 represents Log</span>
<span class="fc" id="L129">            .setMaxRows(maxRows)</span>
<span class="fc" id="L130">            .setMaxBytes(DEFAULT_BYTE_LIMIT);</span>
<span class="fc" id="L131">    TFetchResultsResp response = null;</span>
    try {
<span class="fc" id="L133">      response = thriftClient.FetchResults(request);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">      if (fetchMetadata) {</span>
<span class="fc" id="L135">        response.setResultSetMetadata(getResultSetMetadata(operationHandle));</span>
      }
<span class="fc" id="L137">    } catch (TException e) {</span>
<span class="fc" id="L138">      String errorMessage =</span>
<span class="fc" id="L139">          String.format(</span>
              &quot;Error while fetching results from Thrift server. Request {%s}, Error {%s}&quot;,
<span class="fc" id="L141">              request.toString(), e.toString());</span>
<span class="fc" id="L142">      LOGGER.error(errorMessage);</span>
<span class="fc" id="L143">      throw new DatabricksHttpException(errorMessage, e);</span>
<span class="fc" id="L144">    }</span>
<span class="fc" id="L145">    verifySuccessStatus(</span>
<span class="fc" id="L146">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L147">        String.format(</span>
            &quot;Error while fetching results Request {%s}. TFetchResultsResp {%s}. &quot;,
            request, response));
<span class="fc" id="L150">    return response;</span>
  }

  void longPolling(TOperationHandle operationHandle)
      throws TException, InterruptedException, DatabricksHttpException {
<span class="fc" id="L155">    TGetOperationStatusReq request =</span>
        new TGetOperationStatusReq()
<span class="fc" id="L157">            .setOperationHandle(operationHandle)</span>
<span class="fc" id="L158">            .setGetProgressUpdate(false);</span>
    TGetOperationStatusResp response;
    TStatusCode statusCode;
    do {
<span class="fc" id="L162">      response = thriftClient.GetOperationStatus(request);</span>
<span class="fc" id="L163">      statusCode = response.getStatus().getStatusCode();</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">      if (statusCode == TStatusCode.STILL_EXECUTING_STATUS) {</span>
<span class="nc" id="L165">        Thread.sleep(DEFAULT_SLEEP_DELAY);</span>
      }
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">    } while (statusCode == TStatusCode.STILL_EXECUTING_STATUS);</span>
<span class="fc" id="L168">    verifySuccessStatus(</span>
<span class="fc" id="L169">        statusCode, String.format(&quot;Request {%s}, Response {%s}&quot;, request, response));</span>
<span class="fc" id="L170">  }</span>

  public DatabricksResultSet execute(
      TExecuteStatementReq request,
      IDatabricksStatement parentStatement,
      IDatabricksSession session,
      StatementType statementType)
      throws SQLException {
<span class="fc" id="L178">    refreshHeadersIfRequired();</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    int maxRows = (parentStatement == null) ? DEFAULT_ROW_LIMIT : parentStatement.getMaxRows();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">    if (enableDirectResults) {</span>
<span class="fc" id="L181">      TSparkGetDirectResults directResults =</span>
<span class="fc" id="L182">          new TSparkGetDirectResults().setMaxBytes(DEFAULT_BYTE_LIMIT).setMaxRows(maxRows);</span>
<span class="fc" id="L183">      request.setGetDirectResults(directResults);</span>
    }
<span class="fc" id="L185">    TExecuteStatementResp response = null;</span>
<span class="fc" id="L186">    TFetchResultsResp resultSet = null;</span>
    try {
<span class="fc" id="L188">      response = thriftClient.ExecuteStatement(request);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">      if (response.isSetDirectResults()) {</span>
<span class="fc" id="L190">        checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L191">        resultSet = response.getDirectResults().getResultSet();</span>
<span class="fc" id="L192">        resultSet.setResultSetMetadata(response.getDirectResults().getResultSetMetadata());</span>
      } else {
<span class="fc" id="L194">        longPolling(response.getOperationHandle());</span>
<span class="fc" id="L195">        resultSet =</span>
<span class="fc" id="L196">            getResultSetResp(</span>
<span class="fc" id="L197">                response.getStatus().getStatusCode(),</span>
<span class="fc" id="L198">                response.getOperationHandle(),</span>
<span class="fc" id="L199">                response.toString(),</span>
                maxRows,
                true);
      }
<span class="fc" id="L203">    } catch (TException | InterruptedException e) {</span>
<span class="fc" id="L204">      String errorMessage =</span>
<span class="fc" id="L205">          String.format(</span>
              &quot;Error while receiving response from Thrift server. Request {%s}, Error {%s}&quot;,
<span class="fc" id="L207">              request.toString(), e.toString());</span>
<span class="fc" id="L208">      LOGGER.error(errorMessage);</span>
<span class="fc" id="L209">      throw new DatabricksHttpException(errorMessage, e);</span>
<span class="fc" id="L210">    }</span>
<span class="fc" id="L211">    return new DatabricksResultSet(</span>
<span class="fc" id="L212">        response.getStatus(),</span>
<span class="fc" id="L213">        getStatementId(response.getOperationHandle()),</span>
<span class="fc" id="L214">        resultSet.getResults(),</span>
<span class="fc" id="L215">        resultSet.getResultSetMetadata(),</span>
        statementType,
        parentStatement,
        session);
  }

  private TFetchResultsResp listFunctions(TGetFunctionsReq request)
      throws DatabricksHttpException, TException {
<span class="fc" id="L223">    TGetFunctionsResp response = thriftClient.GetFunctions(request);</span>
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L226">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L227">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L229">    return getResultSetResp(</span>
<span class="fc" id="L230">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L231">        response.getOperationHandle(),</span>
<span class="fc" id="L232">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp listPrimaryKeys(TGetPrimaryKeysReq request)
      throws DatabricksHttpException, TException {
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L240">    TGetPrimaryKeysResp response = thriftClient.GetPrimaryKeys(request);</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L242">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L243">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L245">    return getResultSetResp(</span>
<span class="fc" id="L246">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L247">        response.getOperationHandle(),</span>
<span class="fc" id="L248">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp getTables(TGetTablesReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L256">    TGetTablesResp response = thriftClient.GetTables(request);</span>
<span class="fc bfc" id="L257" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L258">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L259">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L261">    return getResultSetResp(</span>
<span class="fc" id="L262">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L263">        response.getOperationHandle(),</span>
<span class="fc" id="L264">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp getTableTypes(TGetTableTypesReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L272">    TGetTableTypesResp response = thriftClient.GetTableTypes(request);</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L274">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L275">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L277">    return getResultSetResp(</span>
<span class="fc" id="L278">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L279">        response.getOperationHandle(),</span>
<span class="fc" id="L280">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp getCatalogs(TGetCatalogsReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L287" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L288">    TGetCatalogsResp response = thriftClient.GetCatalogs(request);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L290">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L291">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L293">    return getResultSetResp(</span>
<span class="fc" id="L294">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L295">        response.getOperationHandle(),</span>
<span class="fc" id="L296">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp listSchemas(TGetSchemasReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L304">    TGetSchemasResp response = thriftClient.GetSchemas(request);</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L306">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L307">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L309">    return getResultSetResp(</span>
<span class="fc" id="L310">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L311">        response.getOperationHandle(),</span>
<span class="fc" id="L312">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TFetchResultsResp getTypeInfo(TGetTypeInfoReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L320">    TGetTypeInfoResp response = thriftClient.GetTypeInfo(request);</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L322">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L323">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L325">    return getResultSetResp(</span>
<span class="fc" id="L326">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L327">        response.getOperationHandle(),</span>
<span class="fc" id="L328">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        true);
  }

  private TFetchResultsResp listColumns(TGetColumnsReq request)
      throws TException, DatabricksHttpException {
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">    if (enableDirectResults) request.setGetDirectResults(DEFAULT_DIRECT_RESULTS);</span>
<span class="fc" id="L336">    TGetColumnsResp response = thriftClient.GetColumns(request);</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">    if (response.isSetDirectResults()) {</span>
<span class="fc" id="L338">      checkDirectResultsForErrorStatus(response.getDirectResults(), response.toString());</span>
<span class="fc" id="L339">      return response.getDirectResults().getResultSet();</span>
    }
<span class="fc" id="L341">    return getResultSetResp(</span>
<span class="fc" id="L342">        response.getStatus().getStatusCode(),</span>
<span class="fc" id="L343">        response.getOperationHandle(),</span>
<span class="fc" id="L344">        response.toString(),</span>
        DEFAULT_ROW_LIMIT,
        false);
  }

  private TGetResultSetMetadataResp getResultSetMetadata(TOperationHandle operationHandle)
      throws TException {
<span class="fc" id="L351">    TGetResultSetMetadataReq resultSetMetadataReq =</span>
<span class="fc" id="L352">        new TGetResultSetMetadataReq().setOperationHandle(operationHandle);</span>
<span class="fc" id="L353">    return thriftClient.GetResultSetMetadata(resultSetMetadataReq);</span>
  }

  private void refreshHeadersIfRequired() {
<span class="fc" id="L357">    ((DatabricksHttpTTransport) thriftClient.getInputProtocol().getTransport())</span>
<span class="fc" id="L358">        .setCustomHeaders(databricksConfig.authenticate());</span>
<span class="fc" id="L359">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>