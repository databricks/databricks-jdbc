<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatabricksThriftHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jacoco.exec</a> &gt; <a href="index.source.html" class="el_package">com.databricks.jdbc.client.impl.thrift.commons</a> &gt; <span class="el_source">DatabricksThriftHelper.java</span></div><h1>DatabricksThriftHelper.java</h1><pre class="source lang-java linenums">package com.databricks.jdbc.client.impl.thrift.commons;

import static com.databricks.jdbc.client.impl.helper.MetadataResultConstants.NULL_STRING;
import static com.databricks.jdbc.core.DatabricksTypeUtil.*;

import com.databricks.jdbc.client.DatabricksHttpException;
import com.databricks.jdbc.client.impl.thrift.generated.*;
import com.databricks.jdbc.client.sqlexec.ExternalLink;
import com.databricks.sdk.service.sql.ColumnInfoTypeName;
import java.nio.ByteBuffer;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.IntStream;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

<span class="fc" id="L17">public class DatabricksThriftHelper {</span>
<span class="fc" id="L18">  private static final Logger LOGGER = LogManager.getLogger(DatabricksThriftHelper.class);</span>
<span class="fc" id="L19">  public static final List&lt;TStatusCode&gt; SUCCESS_STATUS_LIST =</span>
<span class="fc" id="L20">      List.of(TStatusCode.SUCCESS_STATUS, TStatusCode.SUCCESS_WITH_INFO_STATUS);</span>

  public static TNamespace getNamespace(String catalog, String schema) {
<span class="fc" id="L23">    return new TNamespace().setCatalogName(catalog).setSchemaName(schema);</span>
  }

  public static String byteBufferToString(ByteBuffer buffer) {
<span class="fc" id="L27">    ByteBuffer newBuffer = buffer.duplicate(); // This is to avoid a BufferUnderflowException</span>
<span class="fc" id="L28">    long sigBits = newBuffer.getLong();</span>
<span class="fc" id="L29">    return new UUID(sigBits, sigBits).toString();</span>
  }

  public static ExternalLink createExternalLink(TSparkArrowResultLink chunkInfo, long chunkIndex) {
<span class="fc" id="L33">    return new ExternalLink()</span>
<span class="fc" id="L34">        .setExternalLink(chunkInfo.getFileLink())</span>
<span class="fc" id="L35">        .setChunkIndex(chunkIndex)</span>
<span class="fc" id="L36">        .setExpiration(Long.toString(chunkInfo.getExpiryTime()));</span>
  }

  public static String getStatementId(TOperationHandle operationHandle) {
<span class="fc" id="L40">    return byteBufferToString(operationHandle.getOperationId().guid);</span>
  }

  public static void verifySuccessStatus(TStatusCode statusCode, String errorContext)
      throws DatabricksHttpException {
<span class="fc bfc" id="L45" title="All 2 branches covered.">    if (!SUCCESS_STATUS_LIST.contains(statusCode)) {</span>
<span class="fc" id="L46">      String errorMessage = &quot;Error thrift response received. &quot; + errorContext;</span>
<span class="fc" id="L47">      LOGGER.error(errorMessage);</span>
<span class="fc" id="L48">      throw new DatabricksHttpException(errorMessage);</span>
    }
<span class="fc" id="L50">  }</span>

  public static int getColumnCount(TGetResultSetMetadataResp resultManifest) {
<span class="fc bfc" id="L53" title="All 4 branches covered.">    if (resultManifest == null || resultManifest.getSchema() == null) {</span>
<span class="fc" id="L54">      return 0;</span>
    }
<span class="fc" id="L56">    return resultManifest.getSchema().getColumnsSize();</span>
  }

  /**
   * In metadata operations, a list of singleton lists is obtained. This function extracts metadata
   * values from these TColumn lists based on the data type set in the column.
   *
   * @param List&lt;TColumn&gt; columnList the TColumn from which to extract values
   * @return a singleton list of metadata result
   */
  public static List&lt;List&lt;Object&gt;&gt; extractValues(List&lt;TColumn&gt; columnList) {
<span class="fc bfc" id="L67" title="All 2 branches covered.">    if (columnList == null) {</span>
<span class="fc" id="L68">      return Collections.singletonList(Collections.emptyList());</span>
    }
<span class="fc" id="L70">    List&lt;Object&gt; obj =</span>
<span class="fc" id="L71">        columnList.stream()</span>
<span class="fc" id="L72">            .map(</span>
                column -&gt; {
                  try {
<span class="fc" id="L75">                    return getColumnFirstValue(column);</span>
<span class="fc" id="L76">                  } catch (Exception e) {</span>
                    // In case a column doesn't have an object, add the default null value
<span class="fc" id="L78">                    return NULL_STRING;</span>
                  }
                })
<span class="fc" id="L81">            .collect(Collectors.toList());</span>
<span class="fc" id="L82">    return Collections.singletonList(obj);</span>
  }

  public static List&lt;List&lt;Object&gt;&gt; extractValuesColumnar(List&lt;TColumn&gt; columnList) {
<span class="pc bpc" id="L86" title="1 of 4 branches missed.">    if (columnList == null || columnList.isEmpty()) {</span>
<span class="fc" id="L87">      return Collections.singletonList(Collections.emptyList());</span>
    }
<span class="fc" id="L89">    int numberOfItems = columnList.get(0).getStringVal().getValuesSize();</span>
<span class="fc" id="L90">    return IntStream.range(0, numberOfItems)</span>
<span class="fc" id="L91">        .mapToObj(</span>
            i -&gt;
<span class="fc" id="L93">                columnList.stream()</span>
<span class="fc" id="L94">                    .map(column -&gt; getObjectInColumn(column, i))</span>
<span class="fc" id="L95">                    .collect(Collectors.toList()))</span>
<span class="fc" id="L96">        .collect(Collectors.toList());</span>
  }

  private static Object getObjectInColumn(TColumn column, int index) {
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">    if (column == null) {</span>
<span class="nc" id="L101">      return NULL_STRING;</span>
    }
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">    if (column.isSetStringVal()) {</span>
<span class="fc" id="L104">      return column.getStringVal().getValues().get(index);</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">    } else if (column.isSetBoolVal()) {</span>
<span class="nc" id="L106">      return column.getBoolVal().getValues().get(index);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">    } else if (column.isSetDoubleVal()) {</span>
<span class="nc" id="L108">      return column.getDoubleVal().getValues().get(index);</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">    } else if (column.isSetI16Val()) {</span>
<span class="nc" id="L110">      return column.getI16Val().getValues().get(index);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">    } else if (column.isSetI32Val()) {</span>
<span class="nc" id="L112">      return column.getI32Val().getValues().get(index);</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">    } else if (column.isSetI64Val()) {</span>
<span class="nc" id="L114">      return column.getI64Val().getValues().get(index);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">    } else if (column.isSetBinaryVal()) {</span>
<span class="nc" id="L116">      return column.getBinaryVal().getValues().get(index);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    } else if (column.isSetByteVal()) {</span>
<span class="nc" id="L118">      return column.getByteVal().getValues().get(index);</span>
    }
<span class="nc" id="L120">    return NULL_STRING;</span>
  }

  private static Object getColumnFirstValue(TColumn column) {
<span class="fc" id="L124">    return getColumnValues(column).get(0);</span>
  }

  public static ColumnInfoTypeName getTypeFromTypeDesc(TTypeDesc typeDesc) {
<span class="fc" id="L128">    TTypeId type = getThriftTypeFromTypeDesc(typeDesc);</span>
<span class="fc bfc" id="L129" title="All 15 branches covered.">    switch (type) {</span>
      case BOOLEAN_TYPE:
<span class="fc" id="L131">        return ColumnInfoTypeName.BOOLEAN;</span>
      case TINYINT_TYPE:
      case SMALLINT_TYPE:
<span class="fc" id="L134">        return ColumnInfoTypeName.SHORT;</span>
      case INT_TYPE:
<span class="fc" id="L136">        return ColumnInfoTypeName.INT;</span>
      case BIGINT_TYPE:
<span class="fc" id="L138">        return ColumnInfoTypeName.LONG;</span>
      case FLOAT_TYPE:
<span class="fc" id="L140">        return ColumnInfoTypeName.FLOAT;</span>
      case DOUBLE_TYPE:
<span class="fc" id="L142">        return ColumnInfoTypeName.DOUBLE;</span>
      case VARCHAR_TYPE:
      case STRING_TYPE:
<span class="fc" id="L145">        return ColumnInfoTypeName.STRING;</span>
      case TIMESTAMP_TYPE:
<span class="fc" id="L147">        return ColumnInfoTypeName.TIMESTAMP;</span>
      case BINARY_TYPE:
<span class="fc" id="L149">        return ColumnInfoTypeName.BINARY;</span>
      case DECIMAL_TYPE:
<span class="fc" id="L151">        return ColumnInfoTypeName.DECIMAL;</span>
      case NULL_TYPE:
<span class="fc" id="L153">        return ColumnInfoTypeName.NULL;</span>
      case DATE_TYPE:
<span class="fc" id="L155">        return ColumnInfoTypeName.DATE;</span>
      case CHAR_TYPE:
<span class="fc" id="L157">        return ColumnInfoTypeName.CHAR;</span>
      case INTERVAL_YEAR_MONTH_TYPE:
      case INTERVAL_DAY_TIME_TYPE:
<span class="fc" id="L160">        return ColumnInfoTypeName.INTERVAL;</span>
    }
<span class="fc" id="L162">    return ColumnInfoTypeName.STRING; // by default return string</span>
  }

  /**
   * Extracts values from a TColumn based on the data type set in the column.
   *
   * @param column the TColumn from which to extract values
   * @return a list of values from the specified column
   */
  private static List&lt;?&gt; getColumnValues(TColumn column) {
    // TODO : Handle complex data types
<span class="fc bfc" id="L173" title="All 2 branches covered.">    if (column.isSetBinaryVal()) return column.getBinaryVal().getValues();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">    if (column.isSetBoolVal()) return column.getBoolVal().getValues();</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">    if (column.isSetByteVal()) return column.getByteVal().getValues();</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">    if (column.isSetDoubleVal()) return column.getDoubleVal().getValues();</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">    if (column.isSetI16Val()) return column.getI16Val().getValues();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">    if (column.isSetI32Val()) return column.getI32Val().getValues();</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">    if (column.isSetI64Val()) return column.getI64Val().getValues();</span>
<span class="fc" id="L180">    return column.getStringVal().getValues(); // Default case</span>
  }

  /**
   * Converts columnar data from a TRowSet to a row-based list format.
   *
   * @param rowSet the TRowSet containing the data
   * @return a list where each sublist represents a row with column values, or an empty list if
   *     rowSet is empty
   */
  public static List&lt;List&lt;Object&gt;&gt; convertColumnarToRowBased(TRowSet rowSet) {
<span class="fc" id="L191">    List&lt;List&lt;Object&gt;&gt; columnarData = extractValuesFromRowSet(rowSet);</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">    if (columnarData.isEmpty()) {</span>
<span class="fc" id="L193">      return Collections.emptyList();</span>
    }
<span class="fc" id="L195">    int numRows =</span>
<span class="fc" id="L196">        columnarData.get(0).size(); // Number of rows (if the data was displayed in row format)</span>
<span class="fc" id="L197">    List&lt;List&lt;Object&gt;&gt; rowBasedData =</span>
<span class="fc" id="L198">        IntStream.range(0, numRows)</span>
<span class="fc" id="L199">            .mapToObj(i -&gt; new ArrayList&lt;Object&gt;(columnarData.size()))</span>
<span class="fc" id="L200">            .collect(Collectors.toList());</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">    for (List&lt;Object&gt; column : columnarData) {</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">      for (int rowIndex = 0; rowIndex &lt; numRows; rowIndex++) {</span>
<span class="fc" id="L203">        rowBasedData.get(rowIndex).add(column.get(rowIndex));</span>
      }
<span class="fc" id="L205">    }</span>
<span class="fc" id="L206">    return rowBasedData;</span>
  }

  /**
   * Extracts and returns the values from each column of a TRowSet as a list of lists. Each sublist
   * represents a column of values. Returns an empty list if the input is null or contains no
   * columns.
   *
   * @param rowSet the TRowSet to extract values from
   * @return a list of lists, each containing the values of a column, or an empty list if the input
   *     is invalid
   */
  public static List&lt;List&lt;Object&gt;&gt; extractValuesFromRowSet(TRowSet rowSet) {
<span class="fc bfc" id="L219" title="All 4 branches covered.">    if (rowSet == null || rowSet.getColumns() == null) {</span>
<span class="fc" id="L220">      return Collections.emptyList();</span>
    }
<span class="fc" id="L222">    return rowSet.getColumns().stream()</span>
<span class="fc" id="L223">        .map(DatabricksThriftHelper::getColumnValues)</span>
<span class="fc" id="L224">        .map(list -&gt; new ArrayList&lt;Object&gt;(list))</span>
<span class="fc" id="L225">        .collect(Collectors.toUnmodifiableList());</span>
  }

  public static long getRowCount(TRowSet resultData) {
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">    if (resultData == null) {</span>
<span class="nc" id="L230">      return 0;</span>
    }

<span class="fc bfc" id="L233" title="All 2 branches covered.">    if (resultData.isSetColumns()) {</span>
<span class="fc" id="L234">      List&lt;TColumn&gt; columns = resultData.getColumns();</span>
<span class="pc bpc" id="L235" title="1 of 4 branches missed.">      return columns == null || columns.isEmpty()</span>
<span class="fc" id="L236">          ? 0</span>
<span class="fc" id="L237">          : getColumnValues(resultData.getColumns().get(0)).size();</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">    } else if (resultData.isSetResultLinks()) {</span>
<span class="fc" id="L239">      return resultData.getResultLinks().stream()</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">          .mapToLong(link -&gt; link.isSetRowCount() ? link.getRowCount() : 0)</span>
<span class="fc" id="L241">          .sum();</span>
    }

<span class="fc" id="L244">    return 0;</span>
  }

  public static void checkDirectResultsForErrorStatus(
      TSparkDirectResults directResults, String context) throws DatabricksHttpException {
<span class="fc bfc" id="L249" title="All 2 branches covered.">    if (directResults.isSetOperationStatus()) {</span>
<span class="fc" id="L250">      LOGGER.debug(&quot;direct result operation status being verified for success response&quot;);</span>
<span class="fc" id="L251">      verifySuccessStatus(directResults.getOperationStatus().getStatus().getStatusCode(), context);</span>
    }
<span class="fc bfc" id="L253" title="All 2 branches covered.">    if (directResults.isSetResultSetMetadata()) {</span>
<span class="fc" id="L254">      LOGGER.debug(&quot;direct results metadata being verified for success response&quot;);</span>
<span class="fc" id="L255">      verifySuccessStatus(directResults.getResultSetMetadata().status.getStatusCode(), context);</span>
    }
<span class="fc bfc" id="L257" title="All 2 branches covered.">    if (directResults.isSetCloseOperation()) {</span>
<span class="fc" id="L258">      LOGGER.debug(&quot;direct results close operation verified for success response&quot;);</span>
<span class="fc" id="L259">      verifySuccessStatus(directResults.getCloseOperation().status.getStatusCode(), context);</span>
    }
<span class="fc bfc" id="L261" title="All 2 branches covered.">    if (directResults.isSetResultSet()) {</span>
<span class="fc" id="L262">      LOGGER.debug(&quot;direct result set being verified for success response&quot;);</span>
<span class="fc" id="L263">      verifySuccessStatus(directResults.getResultSet().status.getStatusCode(), context);</span>
    }
<span class="fc" id="L265">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>