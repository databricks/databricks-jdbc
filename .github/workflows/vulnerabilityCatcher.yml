name: Weekly Security Scan

on:
  schedule:
    - cron: '0 0 * * 0'  # Run every Sunday at midnight UTC
  workflow_dispatch:  # Allow manual triggering

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main  # Explicitly check out main branch

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Run OWASP Dependency Check
        run: mvn org.owasp:dependency-check-maven:check -Dnvd.api.key=${{ secrets.NVD_API_KEY }}

      - name: Check for vulnerabilities
        id: check_vulnerabilities
        run: |
          if grep -q "CVSS score >= 7" target/dependency-check-report.html; then
            echo "has_vulnerabilities=true" >> $GITHUB_OUTPUT
            echo "Critical or high vulnerabilities found (CVSS score >= 7)"
            # Generate a simple HTML report for email
            echo "<!DOCTYPE html><html><head><title>JDBC Driver Security Scan Results</title></head><body>" > security-scan-report.html
            echo "<h1>Security Vulnerabilities Found</h1>" >> security-scan-report.html
            echo "<p>Critical or high vulnerabilities (CVSS score >= 7) were found in the weekly scan of the JDBC driver.</p>" >> security-scan-report.html
            echo "<p>Please check the full report in the GitHub Actions artifacts: <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>View Artifacts</a></p>" >> security-scan-report.html
            echo "</body></html>" >> security-scan-report.html
            exit 1
          else
            echo "has_vulnerabilities=false" >> $GITHUB_OUTPUT
            echo "No critical or high vulnerabilities found"
          fi

      - name: Send Email
        if: steps.check_vulnerabilities.outputs.has_vulnerabilities == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: OSS JDBC Driver Security Scan - ðŸš¨ Vulnerabilities Found
          html_body: file://security-scan-report.html
          to: ${{ secrets.EMAIL_RECIPIENTS }}
          from: JDBC Security Scanner
          content_type: text/html

      - name: Upload Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-reports
          path: |
            target/dependency-check-report.html
            target/dependency-check-report.json
            security-scan-report.html